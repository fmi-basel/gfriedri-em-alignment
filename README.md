gfriedri-em-alignment: stitching and alignment of  EM stacks
-----------------------------------------------------
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)
[![tests](https://github.com/fmi-basel/gfriedri-em-alignment/workflows/tests/badge.svg)](https://github.com/fmi-basel/gfriedri-em-alignment/actions)
[![codecov](https://codecov.io/gh/fmi-basel/gfriedri-em-alignment/branch/main/graph/badge.svg)](https://app.codecov.io/gh/fmi-basel/gfriedri-em-alignment)

gfriedri-em-alignment is a tool that does stitching and alignment of tiled volumentric electron microscopy (EM) data. It takes the images and metadata of the EM stack, acquired using the [SBEMimage](https://github.com/SBEMimage/SBEMimage) software, and uses the [SOFIMA](https://github.com/google-research/sofima) tool to perform the stitching and alignment.

# Installation
The tool can be installed via pip
```shell
  pip install git+https://github.com/google-research/sofima
```
# Input data
The folder structure of the input data generated by [SBEMimage](https://github.com/SBEMimage/SBEMimage) is described in its [software documentation](https://sbemimage.readthedocs.io/en/latest/datasets.html).<br/>
Each experiment consists of one or many SBEMimage datasets, which is referred to as blocks. Each block then contains several 2D sections that locates in a range of z-positions. Each section contains a grid of tile images.<br/>
gfriedri-em-alignment will take the SBEMimage dataset folders as input and parse the metadata into the Experiment -> Block -> Section -> Tile hierarchy for downstream processing.


# Usage
- Parse SBEMimage metadata
Before the stitching, the metadata created by SBEMimage needs to be converted to the tile ID maps that can be used as input metadata for [SOFIMA](https://github.com/google-research/sofima).

1. Create an Experiment instance
``` python
from sbem.experiment.Experiment import Experiment

# directory of the SBEMimage dataset (e.g. 2020101_sampleid_run01/)
data_dir = 'sbemimage_dataset_directory/'

# A new Experiment is created with:
exp = Experiment(run_name, data_dir)

```
2. Add a block of sections in the experiment
``` python
# Add a Block
grid_str = "g0001" # string that refers to the grid folder
pixel_size = 11 # pixel size in nano-meters of the tile images
exp.add_block(data_dir, grid_str, pixel_size)
```
3. Save the experiment to an output directory. The tile ID maps for each section will be saved separately for the downstream processing.

``` python
out_dir = 'some_output_directory/'
exp.save(out_dir)
```

- Stitch tiles in each section (2D stitching)

- Align all sections across z-direction (3D alignment)

# License
Licensed under the Apache License, Version 2.0 (the "License"); you may not use this software except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
